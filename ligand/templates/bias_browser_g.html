{% extends "home/base.html" %}
{% load static %}
{% csrf_token %}

{% block addon_css %}
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/construct_browser.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/yadcf_bootstrap_version.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/select2.css' %}" type="text/css" />
    <link href="{% static 'home/css/construct_alignment.css' %}" rel="stylesheet">
    <link href="{% static 'home/css/sequenceviewer.css' %}" rel="stylesheet">
    <link href="{% static 'home/css/modal.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.4.0/css/buttons.dataTables.min.css" type="text/css" />

    <!-- configure radio buttons style -->
    <style>
        biasinline > ul li {
            display: inline-block;
        }

        .highlight {
            /* background-color: red */
            display: none;
        }
    </style>

    <style type="text/css">
        .dataTables_scrollHeadInner {
            margin-top: 20px;
        }

        table.dataTable thead th,
        table.dataTable tbody td {
            max-width: 65px;
            word-break: break-all;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        table.dataTable thead .sorting {
            background-position: right;
        }

        .select2-container select2-container-multi {
            width: 75%;
        }

        .select2-container-multi .select2-choices .select2-search-field input {
            max-width: 50px;
        }

        .yadcf-filter-wrapper {
            position: center;
            display: flex;
            white-space: normal;
            margin-top: 7px;
            width: 50% !important;
        }

        .select2-results {
            background-color: white;
            border: gray;
            width: 150px;
        }

        .yadcf-filter-range {
            grid-auto-columns: auto;
            max-width: 50px !important;
            font-family: sans-serif;
            font-size: 80%;
            font-weight: bold;
            margin: auto;
            margin-top: 10%;
            min-width: 40px;
        }

        table.dataTable thead .sorting {
            background-image: none !important;
        }

        table.dataTable thead .sorting_desc {
            background-image: none !important;
        }

        table.dataTable thead .sorting_asc {
            background-image: none !important;
        }

        table.dataTable.compact tbody th,
        table.dataTable.compact tbody td {
            padding: 5px 10px 5px 0px !important;
            width: 0px;
        }

        table.dataTable.compact thead th,
        table.dataTable.compact thead td {
            padding: 5px 10px 5px 0px;
            width: 0px;
        }

        table.dataTable.compact thead tr.over_header th {
            border-bottom: 1px solid #ccc;
        }

        table.dataTable.compact thead th.leftborder {
            border-left: 1px solid;
        }

        table.dataTable.compact thead th.rightborder {
            border-right: 1px solid;
        }

        .yadcf-filter-range {
            max-width: 40px !important;
            font-family: sans-serif;
            font-size: 80%;
            font-weight: bold;
            min-width: 40px;
        }

        .clicked_button {
            background-color: rgb(215, 215, 215);
        }

        #overlay {
            top: 0px;
            position: absolute;
            background: #f8f8f8;
            /*border: 1px solid #333;*/
            -webkit-box-shadow: 5px 0 2px -2px #888;
            box-shadow: 5px 0 2px -2px #888;
        }

        .container {
            width: 90%;
        }

        .wrapper {
            overflow-x: scroll;
            overflow-y: hidden;
        }

        #overlay tbody tr {
            background-color: #f8f8f8;
        }

        #count_row th {
            font-size: 11px;
            text-align: center;
        }

        .switch-field label:hover {
            cursor: pointer;
            /* width: 100%; */
        }

        .switch-field input:checked+label {
            background-color: #337ab7;
            /* #a5dc86; */
            box-shadow: none;
        }

        .border-left {
            padding-left: 3px;
        }

        .switch-field label:first-of-type {
            border-radius: 4px 0 0 4px;

        }

        .switch-field label:last-of-type {
            border-radius: 0 4px 4px 0;
        }

        /* This is just for CodePen. */

        .name {
            width: 100px;
            text-overflow: ellipsis;
            cursor: pointer;
            word-break: break-all;
            overflow: hidden;
            white-space: nowrap;
        }

        .name:hover {
            overflow: visible;
            white-space: normal;

        }

        .toolbar_data_css {
            width: 250px;
            margin-right: auto;
            margin-left: 0px;
            /* border: 1px solid; */
            font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
            font-weight: normal;
            font-size: 120%;
            line-height: 1.625;
        }

        .toolbar_data_css.td {
            height: 15px;
            max-width: 150px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
    </style>

{% endblock %}

{% block content %}
    <a id="dlink" style="display:none;"></a>
    <div id="excel_table" style2="display:none;"></div>
    <div style="display:block;">
        <div style="display:inline; float:left;">
            <h2 style="width:auto; display:inline;">Ligand bias for G protein subtype</h2>
        </div>
        <div style="float:left; padding:4px 0px 0px 6px;">
            <div style="font-size: 10px; ">
                <a href="https://academic.oup.com/nar/article/44/D1/D356/2502664"> read article</a><br>
                <a href="https://academic.oup.com/nar/article/44/D1/D356/2502664"> latest GPCRdb article</a>
            </div>
        </div>
    </div>
    <br><br>

    <img id="loadingSpinner" style="position: absolute;
    left: 50%;
    top: 50%;" src="{% static 'home/images/loading.gif' %}" />

    {% if data %}
        {% autoescape off %}

            <div class='biasinline' style='padding-top: 0px; font-size: 10px; white-space: nowrap; overflow-y:hidden; display:inline-block; width:100%;'>
                <div class="toolbar_data_css" id="toolbar_data">
                    <table class="display compact text-nowrap toolbar_data_css">
                        <thead>
                        <tr>
                            <h4>Showing unique:</h4>
                        </tr>
                        </thead>

                        <tr>
                            <td>Ligands</td>
                            <td id="ligand_counter"></td>
                        </tr>
                        <tr>
                            <td>Receptors</td>
                            <td id="receptor_counter"></td>
                        </tr>
                    </table>
                </div>
                <div id='structures_scrollable_div'>
                    <!-- <div style="padding-top: 10px; font-size: 11px; white-space: nowrap;"> -->
                    <table class="display compact text-nowrap" id='structures_scrollable' style="width: 100%">
                        <thead id="headers">
                        <tr rowspan="2">
                            <th><a href="#"><span class="glyphicon glyphicon-info-sign"></span></a></th>
                            <th id="receptor" style="text-align:left" colspan="6">
                                Receptor</th>
                            <th style="border-left: 1px solid black; text-align:left" colspan="5" style="">
                                Tested Ligand Pair </th>
                            <th id="transducers" style="border-left: 1px solid black; text-align:left" colspan="2" style="">
                                Receptor transducers</th>
                            <th id="pathways" style="border-left: 1px solid black; text-align:left" colspan="5">
                                Pathway Bias Rank Order </th>
                            <th id="opmodel" class="shade" style="border-left: 1px solid black; text-align:left" colspan="4">
                                Operational model <br> &#916;&#916;(Tau/Ka)</th>
                            <th id="lbf" class="shade" style="border-left: 1px solid black; text-align:left" colspan="4">
                                Intrinsic relative<br>activity<br>(&#916;&#916;Log(Emax/EC50))</th>
                            <th id="potency" class="shade" style="border-left: 1px solid black; text-align:left" colspan="4">
                                Potency ratio</th>
                            <th id="activity" class="shade" style="border-left: 1px solid black; text-align:left" colspan="5">
                                Potency (pEC50 or<br>
                                <font color="#FF0000">IC50)</font>
                            </th>
                            <th id="emax" class="shade" style="border-left: 1px solid black; text-align:left" colspan="5">
                                Emax (% of ref ligand)</th>
                            <th id="tfactor" class="shade" style="border-left: 1px solid black; text-align:left" colspan="5">
                                Transduction coefficient</th>
                            <th id="assay" style="border-left: 1px solid black; text-align:left" colspan="5">
                                Assay</th>
                            <th id="cell" style="border-left: 1px solid black; text-align:left" colspan="5">
                                Cell line</th>
                            <th id="time" style="border-left: 1px solid black; text-align:left" colspan="5">
                                Time resolved</th>
                            <th style="border-left: 1px solid black; text-align:left; overflow: hidden;
                              white-space: nowrap;
                              text-overflow: ellipsis;
                      max-width: 250px;" colspan="2">Reference</th>
                        </tr>
                        <tr>
                            <!-- Receptor -->
                            <th><a href="#"><span class="glyphicon glyphicon-info-sign"></span></a></th>
                            <th class="receptor">Class<br></th>
                            <th class="receptor" title="Receptor Family">Rec Fam</th>
                            <th class="receptor">UniProt</th>
                            <th class="receptor">IUPHAR</th>
                            <th class="receptor">Species</th>
                            <th class="receptor">Endogenous<br>Ligand</th>
                            <!-- Ligand -->
                            <th class="ligand" style="border-left: 1px solid black;">Reference</th>
                            <th class="ligand">Biased</th>
                            <th class="ligand" id='vendor'>#Ven<br>dors</th>
                            <th class="ligand">#Arti<br>cles</th>
                            <th class="ligand">#Labs<br> </th>
                            <!-- Receptor trunsducers-->
                            <th class="transducers" style="border-left: 1px solid black;">Primary</th>
                            <th class="transducers">Secondary</th>
                            <!-- Pathways -->
                            <th class="pathways" style="border-left: 1px solid black;">P 1</th>
                            <th class="pathways">P 2</th>
                            <th class="pathways">P 3</th>
                            <th class="pathways">P 4</th>
                            <th class="pathways">P 5</th>
                            <!-- operational model -->
                            <th class="operational shade" id='column0' style="border-left: 1px solid black;">P 2 / P 1 </th>
                            <th class="operational shade" id='column1'>P 3 / P 1</th>
                            <th class="operational shade" id='column2'>P 4 / P 1</th>
                            <th class="operational shade" id='column3'>P 5 / P 1</th>
                            <!-- log bias factor -->
                            <th class="lbf shade" id='column4' style="border-left: 1px solid black;">P 2 / P 1</th>
                            <th class="lbf shade" id='column5'>P 3 / P 1</th>
                            <th class="lbf shade" id='column7'>P 4 / P 1</th>
                            <th class="lbf shade" id='column8'>P 5 / P 1</th>
                            <!-- Potency ratio -->
                            <th class="potency shade" id='column9' style="border-left: 1px solid black;">P 2 / P 1</th>
                            <th class="potency shade" id='column10'>P 3 / P 1</th>
                            <th class="potency shade" id='column12'>P 4 / P 1</th>
                            <th class="potency shade" id='column13'>P 5 / P 1</th>
                            <!-- Potency -->
                            <th class="activity shade" id='column14' style="border-left: 1px solid black;">P 1 </th>
                            <th class="activity shade" id='column15'>P 2</th>
                            <th class="activity shade" id='column16'>P 3</th>
                            <th class="activity shade" id='column17'>P 4</th>
                            <th class="activity shade" id='column18'>P 5</th>
                            <!-- emax -->
                            <th class="emax shade" id='column19' style="border-left: 1px solid black;">P 1</th>
                            <th class="emax shade" id='column20'>P 2</th>
                            <th class="emax shade" id='column21'>P 3</th>
                            <th class="emax shade" id='column22'>P 4</th>
                            <th class="emax shade" id='column23'>P 5</th>
                            <!-- transduction efficacy -->
                            <th class="tfactor shade" id='column24' style="border-left: 1px solid black;">P 1</th>
                            <th class="tfactor shade" id='column25'>P 2</th>
                            <th class="tfactor shade" id='column26'>P 3</th>
                            <th class="tfactor shade" id='column27'>P 4</th>
                            <th class="tfactor shade" id='column28'>P 5</th>
                            <!-- Assay type -->
                            <th class="assay" style="border-left: 1px solid black;">P 1</th>
                            <th class="assay">P 2</th>
                            <th class="assay">P 3</th>
                            <th class="assay">P 4</th>
                            <th class="assay">P 5</th>
                            <!-- Cell Line -->
                            <th class="cell" style="border-left: 1px solid black;">P 1</th>
                            <th class="cell">P 2</th>
                            <th class="cell">P 3</th>
                            <th class="cell">P 4</th>
                            <th class="cell">P 5</th>
                            <!-- Time resolved -->
                            <th class="time" style="border-left: 1px solid black;">P 1</th>
                            <th class="time">P 2</th>
                            <th class="time">P 3</th>
                            <th class="time">P 4</th>
                            <th class="time">P 5</th>
                            <!-- Authors -->
                            <th style="overflow: hidden;
          white-space: nowrap;
          text-overflow: ellipsis;
          max-width: 100px; border-left: 1px solid black;">Authors</th>
                            <th style="border-right: 1px solid black;">DOI/ <br>Reference</th>
                        </tr>
                        </thead>
                        <tbody id='structures_scrollable_body' style="display:none">
                        {%for e in data.items%}
                            <tr>
                                <td>
                                    <span style='display: none'> {{e.1.ligand.id}}</span>
                                    <a href="#">
                                        <span class="glyphicon glyphicon-info-sign" onclick="myFunction('experiment/{{e.1.experiment_id}}/detail', 'Detail View', window, 1500, 1000)"></span>
                                    </a>
                                </td>

                                <!-- s.protein_conformation.protein.parent.family.parent.parent.parent.shorter() -->
                                <td title='{{e.1.class}}'>{{e.1.class}}</td>
                                <td title='{{e.1.receptor.family.parent}}'>{{e.1.receptor.family.parent}}</td>
                                <td title='{{e.1.uniprot}}'>{{e.1.uniprot}}</td>
                                <td title='{{e.1.IUPHAR}}'>{{e.1.IUPHAR}}</td>
                                <td title='{{e.1.receptor.species.common_name}}'>{{e.1.receptor.species.common_name}}</td>
                                {% if e.1.endogenous_ligand == None %}
                                    <td></td>
                                {%else%}
                                    <td title='{{e.1.endogenous_ligand}}'>{{e.1.endogenous_ligand}}</td>
                                {%endif%}
                                <!-- ligand -->
                                <td title='{{e.1.reference_ligand}}' style="border-left: 1px solid black;">{{e.1.reference_ligand}}</td>
                                <td title='{{e.1.ligand}}'>
                                    <!-- {%if e.1.chembl%}
                            <a href='/ligand/{{e.1.chembl}}' target='blank'>
                            {%endif%} -->
                                    {{e.1.ligand}}
                                </td>
                                <td>{{e.1.vendor_quantity}}</td>
                                <td>{{e.1.publication_quantity}}</td>
                                <td>{{e.1.lab_quantity}}</td>

                                <!-- receptor trunsducers -->
                                <td style="border-left: 1px solid black;">{{e.1.primary}}</td>
                                <td>{{e.1.secondary}}</td>

                                <!-- pathways -->
                                {% for ex in e.1.biasdata|dictsort:"order_no" %}
                                    {% if forloop.first %}
                                        <td class="pathway" style="border-left: 1px solid black;">{{ex.family}}</td>
                                    {% else %}
                                        <td class="pathway">{{ex.family}}</td>
                                    {%endif%}
                                {%endfor%}

                                <!-- t factor -->
                                {% for ex in e.1.biasdata|dictsort:"order_no" %}
                                    {% if not forloop.first %}
                                        <td class="shade" style="text-align:right">{{ex.t_factor}}</td>
                                    {%endif%}
                                {%endfor%}

                                <!-- log bias facrtor -->
                                {% for ex in e.1.biasdata|dictsort:"order_no" %}
                                    {% if not forloop.first %}
                                        <td class="shade" style="text-align:right"> {{ex.log_bias_factor }}</td>
                                    {%endif%}
                                {%endfor%}

                                <!-- potency ratio -->
                                {% for ex in e.1.biasdata|dictsort:"order_no" %}
                                    {% if not forloop.first %}
                                        <td class="shade" style="text-align:right">{{ex.potency }}</td>
                                    {%endif%}
                                {%endfor%}

                                <!-- potency -->
                                {% for ex in e.1.biasdata|dictsort:"order_no" %}
                                    {%if ex.quantitive_activity_initial %}
                                        {%if ex.quantitive_measure_type == 'EC50' %}
                                            <td class="shade" style="text-align:right">{{ex.quantitive_activity_initial}} </td>
                                        {%else%}
                                            <td class="shade" style="text-align:right">
                                                <font color="#FF0000">{{ex.quantitive_activity_initial}} </font>
                                            </td>
                                        {%endif%}
                                    {%else%}
                                        <td class="shade">{{ex.qualitative_activity}}</td>
                                    {%endif%}
                                {%endfor%}

                                <!-- E max -->
                                {% for ex in e.1.biasdata|dictsort:"order_no" %}
                                    <td class="shade" style="text-align:right">{{ex.quantitive_efficacy}}</td>
                                {%endfor%}

                                <!-- T coefficient -->
                                {% for ex in e.1.biasdata|dictsort:"order_no" %}
                                    {% if ex.t_coefficient == None %}
                                        <td class="shade"></td>
                                    {%else%}
                                        <td class="shade" style="text-align:right">{{ex.t_coefficient}}</td>
                                    {%endif%}
                                {%endfor%}

                                <!-- Assay -->
                                {% for ex in e.1.biasdata|dictsort:"order_no" %}

                                    <td title='{{ex.assay_type}}'>{{ex.assay_type }}</td>

                                {%endfor%}

                                <!-- Cell line -->
                                {% for ex in e.1.biasdata|dictsort:"order_no" %}

                                    <td>{{ex.cell_line }}</td>

                                {%endfor%}

                                <!-- Time resolved -->
                                {% for ex in e.1.biasdata|dictsort:"order_no" %}

                                    <td>{{ex.assay_time_resolved }}</td>

                                {%endfor%}

                                <!-- Reference -->
                                <td class="name" style="border-left: 1px solid black;">
                                    {{e.1.publication.authors}}</td>
                                <td class="name">
                                    <a href='{{e.1.publication.web_link}}' target='blank'>
                                        {{e.1.publication.web_link.index}}</a></td>

                            </tr>
                        {%endfor%}
                        </tbody>
                    </table>
                </div>
                <!-- </div> -->
                <!-- </div> -->
            </div>
        {% endautoescape %}
    {% else %}
        <p> Ooops! There is no data to show here yet. </p>
        <script>
            document.getElementById("loadingSpinner").style.display = "none";
        </script>
    {% endif %}

    <br>
    <br>
{% endblock %}

{% block addon_js %}
    <script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>
    <script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"> </script>
    <script src="{% static 'home/js/dataTables.buttons.min.js' %}"> </script>
    <script src="{% static 'home/js/select2.js' %}"> </script>
    <script src="{% static 'home/js/shading.js' %}"></script>

    <script type="text/javascript">
        function calculate_header(ids) {
            $("#receptor").attr("colspan", 6);
            $("#ligand").attr("colspan", 5);
            $("#transducers").attr("colspan", 2);
            $("#pathways").attr("colspan", 5);
            $("#opmodel").attr("colspan", 4);
            $("#lbf").attr("colspan", 4);
            $("#potency").attr("colspan", 4);
            $("#activity").attr("colspan", 5);
            $("#emax").attr("colspan", 5);
            $("#tfactor").attr("colspan", 5);
            $("#assay").attr("colspan", 5);
            $("#cell").attr("colspan", 5);
            $("#time").attr("colspan", 5);
            setTimeout(function() {
                $("#receptor").attr("colspan", 6 - document.getElementsByClassName("receptor highlight").length );
                $("#ligand").attr("colspan", 5 - document.getElementsByClassName("ligand highlight").length );
                $("#transducers").attr("colspan", 2 - document.getElementsByClassName("transducers highlight").length );
                $("#pathways").attr("colspan", 5 - document.getElementsByClassName("pathways highlight").length );
                $("#opmodel").attr("colspan", 4 - document.getElementsByClassName("operational highlight").length );
                $("#lbf").attr("colspan", 4 - document.getElementsByClassName("lbf highlight").length );
                $("#potency").attr("colspan", 4 - document.getElementsByClassName("potency highlight").length );
                $("#activity").attr("colspan", 5 - document.getElementsByClassName("activity highlight").length );
                $("#emax").attr("colspan", 5 - document.getElementsByClassName("emax highlight").length );
                $("#tfactor").attr("colspan", 5 - document.getElementsByClassName("tfactor highlight").length );
                $("#assay").attr("colspan", 5 - document.getElementsByClassName("assay highlight").length );
                $("#cell").attr("colspan", 5 - document.getElementsByClassName("cell highlight").length );
                $("#time").attr("colspan", 5 - document.getElementsByClassName("time highlight").length );

            }, 200);
            var a = document.getElementsByClassName("operational highlight").length;
            var b = document.getElementsByClassName("lbf highlight").length ;
            var c = document.getElementsByClassName("tfactor highlight").length ;
            var d = document.getElementsByClassName("pathways highlight").length;

            if (a%2===0 && a == 4) {
                $("#opmodel").addClass('highlight');
            }
            if (b%2===0 &&  b == 4) {
                $("#lbf").addClass('highlight');
            }
            if (c == 5) {
                $("#tfactor").addClass('highlight');
            }
            if ( d == 5) {
                $("#pathways").addClass('highlight');
            }

        }

        function getCookie(c_name) {
            if (document.cookie.length > 0) {
                c_start = document.cookie.indexOf(c_name + "=");
                if (c_start != -1) {
                    c_start = c_start + c_name.length + 1;
                    c_end = document.cookie.indexOf(";", c_start);
                    if (c_end == -1) c_end = document.cookie.length;
                    return unescape(document.cookie.substring(c_start, c_end));
                }
            }
            return "";
        }
        $(document).ready(function() {

            var table = $('#structures_scrollable').DataTable({
                dom: 'B<>ftrip',
                StateSave: true,
                scrollX: '100%',
                scrollY: '60vh',
                scrollCollapse: true,
                AutoWidth: false,
                pageLength: 75,
                "order": [
                    [3, "desc"]
                ],
                "deferRender": true,
                buttons: [{
                    text: 'Excel',
                    className: 'btn btn-primary',
                    titleAttr: 'Download excel',
                    init: function(api, node, config) {
                        $(node).removeClass('dt-button buttons-excel buttons-html5');
                    },
                    action: function(e, dt, node, config) {
                        tableToExcel('structures_scrollable', 'Biased Ligand Data', 'GPCRdb_biased_ligands.xls')
                    },
                },
                    {
                        text: 'Reset All Filters',
                        className: 'btn btn-primary',
                        titleAttr: 'Reset All Filters',
                        init: function(api, node, config) {
                            $(node).removeClass('dt-button buttons-excel buttons-html5');
                        },
                        action: function(e, dt, node, config) {
                            reset_filters()
                        },
                    },
                    {
                        text: 'Get Vendors',
                        className: 'btn btn-primary',
                        titleAttr: 'Vendors info for top 20 ligands',
                        init: function(api, node, config) {
                            $(node).removeClass('dt-button buttons-excel buttons-html5');
                        },
                        action: function(e, dt, node, config) {
                            var id = read_ids()
                            var result
                            $.ajaxSetup({
                                headers: {
                                    "X-CSRFToken": getCookie("csrftoken")
                                }
                            });
                            $.ajax({
                                type: 'POST',
                                url: '/ligand/vendors',
                                data: {
                                    ids: id,
                                    csrfmiddlewaretoken: '{{csrf_token }}',
                                    action: 'post',
                                },
                                success: function() {

                                    myFunction('/ligand/browservendors', 'Detail View', window, 850, 1000)
                                }
                            });
                        },
                    },
                ],
                "initComplete": function(settings, json) {
                    $('#loadingSpinner').show();
                    $('#structures_scrollable_body').hide();
                    setTimeout(function() {
                        $('#loadingSpinner').hide();
                        $('#structures_scrollable_body').show();
                        var column_ids = [];
                        var columnData = [];
                        $('#structures_scrollable').removeClass("highlight");
                        table.columns().flatten().each(function(colIdx) {
                            var columnData = [];
                            table.rows({
                                filter: 'applied'
                            }).data().each(function(i) {
                                columnData.push(i[colIdx]);
                            })
                            if (columnData.join('').length == 0 && colIdx != 0) {
                                $(table.column(colIdx).nodes()).addClass('highlight');
                                $(table.column(colIdx).header()).addClass('highlight');
                                column_ids.push(colIdx);
                            }
                        });
                        calculate_header(column_ids);

                        var ligand_counter = read_unique_ids();
                        var receptor_counter = read_unique_ids_receptor();
                        document.getElementById("ligand_counter").innerHTML = ligand_counter;
                        document.getElementById("receptor_counter").innerHTML = receptor_counter;
                        shadeTable(table, [".shade"], 120, 200);
                        table.columns.adjust();
                    }, 1);
                },
                "fnDrawCallback": function() {
                    $('#loadingSpinner').show();
                    $('#structures_scrollable_body').hide();
                    setTimeout(function() {
                        $('#loadingSpinner').hide();
                        $('#structures_scrollable_body').show();
                        var column_ids = [];
                        var columnData = [];
                        $('#structures_scrollable').removeClass("highlight");
                        table.columns().flatten().each(function(colIdx) {
                            var columnData = [];
                            table.rows({
                                filter: 'applied'
                            }).data().each(function(i) {
                                columnData.push(i[colIdx]);
                            })
                            if (columnData.join('').length == 0 && colIdx != 0) {
                                $(table.column(colIdx).nodes()).addClass('highlight');
                                $(table.column(colIdx).header()).addClass('highlight');
                                column_ids.push(colIdx);
                            }
                        });
                        calculate_header(column_ids);
                        var ligand_counter = read_unique_ids();
                        var receptor_counter = read_unique_ids_receptor();
                        document.getElementById("ligand_counter").innerHTML = ligand_counter;
                        document.getElementById("receptor_counter").innerHTML = receptor_counter;
                        shadeTable(table, [".shade"], 120, 200);

                    }, 1);
                }
            });

            yadcf.init(table,
                [{
                    column_number: 1,
                    filter_type: "multi_select",
                    select_type: 'select2',
                    filter_default_label: "Class",
                    filter_reset_button_text: false,
                },
                    {
                        column_number: 2,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Select",
                        filter_reset_button_text: false,

                    },
                    {
                        column_number: 3,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        //column_data_type: "html",
                        filter_default_label: "Select",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 4,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Select",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 5,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Select",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 6,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Select",
                        filter_reset_button_text: false,
                    },
                    // Ligand
                    {
                        column_number: 7,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Select",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 8,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_default_label: "Select",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 9,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_plugin_options: {
                            width: '30px'
                        },
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 10,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_plugin_options: {
                            width: '30px'
                        },
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 11,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    //  Receotor Transduction
                    {
                        column_number: 12,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Select",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 13,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Select",
                        filter_reset_button_text: false,
                    },
                    // pathway_bias
                    {
                        column_number: 14,
                        select_type: 'select2',
                        filter_type: "multi_select",
                        text_data_delimiter: " ",
                        filter_default_label: "P 1",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 15,
                        select_type: 'select2',
                        filter_type: "multi_select",
                        filter_default_label: "P 2",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 16,
                        select_type: 'select2',
                        filter_type: "multi_select",
                        filter_default_label: "P 3",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 17,
                        select_type: 'select2',
                        filter_type: "multi_select",
                        filter_default_label: "P 4",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 18,
                        select_type: 'select2',
                        filter_type: "multi_select",
                        filter_default_label: "P 5",
                        filter_reset_button_text: false,
                    },
                    // pathway operational model
                    {
                        column_number: 19,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 20,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 21,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 22,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },

                    //Log bias factor <br>(ddLog(Emax/EC50)
                    {
                        column_number: 23,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 24,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 25,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 26,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    //"Potency ratio ddlog(EC50)"
                    {
                        column_number: 27,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 28,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 29,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 30,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    //potency or ic50
                    // TODO: change to p value
                    {
                        column_number: 31,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 32,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 33,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 34,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 35,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },

                    // Emax
                    {
                        column_number: 36,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },

                    {
                        column_number: 37,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 38,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 39,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 40,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    //Transduction eff
                    {
                        column_number: 41,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 42,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 43,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 44,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 45,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        filter_reset_button_text: false,
                    },
                    //assay_type
                    {
                        column_number: 46,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Assay type",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 47,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Assay type",
                        filter_reset_button_text: false,

                    },
                    {
                        column_number: 48,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Assay type",
                        filter_reset_button_text: false,
                    },

                    {
                        column_number: 49,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Assay type",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 50,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Assay type",
                        filter_reset_button_text: false,
                    },
                    //cell_line
                    {
                        column_number: 51,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Cell Line",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 52,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Cell Line",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 53,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Cell Line",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 54,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Cell Line",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 55,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Cell Line",
                        filter_reset_button_text: false,
                    },
                    //Time resolved
                    {
                        column_number: 56,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 57,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 58,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 59,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 60,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "",
                        filter_reset_button_text: false,
                    },
                    //Article
                    {
                        column_number: 61,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Authors",
                        filter_reset_button_text: false,

                    },
                    {
                        column_number: 62,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_default_label: "DOI",
                        filter_reset_button_text: false,
                    },

                ], {
                    cumulative_filtering: true
                }
            );
            shadeTable(table, [".shade"], 120, 200);

            function reset_filters() {
                $('#loadingSpinner').show();
                $('#structures_scrollable_body').hide();
                location.reload()
                //yadcf.exResetAllFilters(oTable);
            }
            table.columns.adjust();
            $('.dataTables_scrollBody #structures_scrollable').addClass("pull-left");

            $('.dataTables_scrollBody').append('<div id=overlay><table id="overlay_table" class="row-border text-center compact dataTable no-footer text-nowrap"><tbody></tbody></table></div>');

            function create_overlay() {
                // This function fires upon filtering, to update what rows to show as an overlay
                $("#overlay_table tbody tr").remove();
                var $target = $("#overlay_table tbody");
                $("#structures_scrollable tbody tr").each(function() {
                    var $tds = $(this).children(),
                        $row = $("<tr></tr>");
                    // $row.append($tds.eq(0).clone()).append($tds.eq(1).clone()).appendTo($target);
                    // var clone_this = document.getElementById("potency_id2").clone()
                    var $tr = document.getElementsByClassName('tr_clone');

                    var $clone = [$tr];

                    $row.append($tds.eq(0).clone()).append($tds.eq(4).clone()).append($tds.eq(5).clone()).append($tds.eq(8).clone());
                    // .id = "pathways"
                    if ($tds[12].className == "pathway") {
                        $row.append($tds.eq(12).clone());
                    }
                    if ($tds[13].className == "pathway") {
                        $row.append($tds.eq(13).clone());
                    }
                    if ($tds[11].className == "pathway") {
                        $row.append($tds.eq(11).clone());
                    }
                    if ($tds[14].className == "pathway") {
                        $row.append($tds.eq(14).clone());
                    }
                    if ($tds[15].className == "pathway") {
                        $row.append($tds.eq(15).clone());
                    } // && isNaN($tds[15].innerText)
                    if ($tds[16].className == "pathway") {
                        $row.append($tds.eq(16).clone());
                    }
                    if ($tds[17].className == "pathway") {
                        $row.append($tds.eq(17).clone());
                    }
                    if ($tds[18].className == "pathway") {
                        $row.append($tds.eq(18).clone());
                    }
                    $row.appendTo($target)
                    $row.height($(this).height());
                });
                $("#overlay_table .border-right").removeClass("border-right");
            }
            // Function that detects filtering events
            $('#structures_scrollable').on('draw.dt', function(e, oSettings) {
                create_overlay();
                table.columns.adjust();
            });
            create_overlay();
            $("#overlay").hide();
            var left = 0;
            var old_left = 0;
            $('.dataTables_scrollBody').scroll(function() {
                // If user scrolls and it's >100px from left, then attach fixed columns overlay
                left = $('.dataTables_scrollBody').scrollLeft();
                if (left != old_left) $("#overlay").hide();
                old_left = left;
                if (left > 100) {
                    $("#overlay").css({
                        left: left + 'px'
                    });
                    if ($("#overlay").is(":hidden")) $("#overlay").show();
                }
            });
            var tableToExcel = (function() {
                var uri = 'data:application/vnd.ms-excel;base64,',
                    template =
                        '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>',
                    base64 = function(s) {
                        return window.btoa(unescape(encodeURIComponent(s)))
                    },
                    format = function(s, c) {
                        return s.replace(/{(\w+)}/g, function(m, p) {
                            return c[p];
                        })
                    }
                return function(table, name, filename) {
                    var table = $("#" + table).clone();
                    $("#excel_table").html(table);
                    // Clean up table to remove yadcf stuff
                    $("#excel_table thead tr").css('height', '');
                    $("#excel_table thead th").css('height', '');
                    $("#excel_table thead div").css('height', '');
                    $("#excel_table thead .yadcf-filter-wrapper").remove();
                    $("#excel_table thead button").remove();
                    var tr = $("#excel_table thead tr:eq(1)");
                    // reattach th titles
                    tr.find('th').each(function(column, th) {
                        if ($(th).attr('title')) $(th).html($(th).attr('title'));
                    });

                    var ctx = {
                        worksheet: name || 'Worksheet',
                        table: $("#excel_table").html()
                    }
                    $("#excel_table").html("");
                    document.getElementById("dlink").href = uri + base64(format(template, ctx));
                    document.getElementById("dlink").download = filename;
                    document.getElementById("dlink").click();
                }
            })()
        });
    </script>
    <script type="text/javascript">
        function myFunction(url, title, win, w, h) {
            const y = win.top.outerHeight / 2 + win.top.screenY - (h / 2);
            const x = win.top.outerWidth / 2 + win.top.screenX - (w / 2);
            return win.open(url, title, 'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=' + w + ', height=' + h + ', top=' + y + ', left=' + x);
        }

        function read_unique_ids() {
            var ids = [];
            var table = document.getElementById("structures_scrollable")
            var temp_lenght = table.rows.length;
            var l = 0;
            for (var i = 2; i < temp_lenght; i++) {
                var x = table.rows[i].cells[0];
                ids.push($(x).find('span:first')[0].innerText)
            }
            l = countUnique(ids);
            return l
        }

        function read_unique_ids_receptor() {
            var ids = [];
            var table = document.getElementById("structures_scrollable")
            var temp_lenght = table.rows.length;
            var l = 0;
            for (var i = 2; i < temp_lenght; i++) {
                var x = table.rows[i].cells[2];

                ids.push($(x)[0].innerText)
            }
            l = countUnique(ids);
            return l
        }

        function countUnique(iterable) {
            return new Set(iterable).size;
        }

        function read_ids() {
            var ids = [];
            var table = document.getElementById("structures_scrollable")
            var temp_lenght = table.rows.length;
            if (temp_lenght > 22) {
                temp_lenght = 22;
            }
            for (var i = 2; i < temp_lenght; i++) {
                var x = table.rows[i].cells[0];
                ids.push($(x).find('span:first')[0].innerText)
            }
            var myJSON = JSON.stringify(ids);
            return myJSON
        }
    </script>
{% endblock %}


