{% extends "home/base.html" %}
{% load static %}
{% load structure_extras %}

{% block addon_css %}
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/construct_browser.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/yadcf_bootstrap_version.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/select2.css' %}" type="text/css" />
    <link href="{% static 'home/css/construct_alignment.css' %}" rel="stylesheet">
    <link href="{% static 'home/css/sequenceviewer.css' %}" rel="stylesheet">
    <link href="{% static 'home/css/modal.css' %}" rel="stylesheet">
    <style type="text/css">
        .select2-result-label{
            font-size:x-small;
            font-size: 10px;
        }

        #filters{

            font-size: 10px;
            padding:  7px 15px; 
        }

        @media (min-width: 1600px){
            #content {
                width: 1570px;
            }
        }
        @media (min-width: 1800px){
            #content {
                width: 1770px;
            }
        }

        table.dataTable.compact thead th.over_header {
            border-right: 1px solid;
            border-left: 0px solid;
            text-align: center;
            padding: 4px 4px 4px 4px;
        }

        table.dataTable.compact thead tr.over_header th {
            border-bottom: 1px solid #ccc;
        }

        table.dataTable.compact thead th.leftborder {
            border-left: 1px solid;
        }

        table.dataTable.compact thead th.rightborder {
            border-right: 1px solid;
        }

        table.dataTable.compact thead th.checkbox_tr {
            text-align: left;
            padding: 4px 4px 4px 4px;
        }

        table.dataTable.compact thead th {
            padding: 4px 16px 4px 2px;
        }
        .yadcf-filter-wrapper {
            margin-top: 0px;
        }
        input.yadcf-filter  {
            width: 100px;
            font-family: sans-serif;
            font-size: 100%;
            font-weight: bold;
        }
        .yadcf-filter-range-date, .yadcf-filter-range-number {
            width: 30px;
            font-family: sans-serif;
            font-size: 100%;
            font-weight: bold;
        }
        /*#yadcf-filter--structures_scrollable-from-12 {
            width: 10px;
        }
        #yadcf-filter--structures_scrollable-to-12 {
            width: 10px;
        }
        .yadcf-filter-wrapper-inner--structures_scrollable-12 {
            width: 5px;
        }*/
        .clicked_button {
            background-color: rgb(215,215,215);
        }
        .wrapper {
          overflow-x: scroll;
          overflow-y:hidden;
        }

        #overlay
        {
            top: 0px;
            position: absolute;
            background: #f8f8f8;
          /*border: 1px solid #333;*/
          -webkit-box-shadow: 5px 0 2px -2px #888;
                  box-shadow: 5px 0 2px -2px #888;
        }
        #overlay tbody tr {
             background-color: #f8f8f8; 
        }
        .highlight {
            background-color: rgb(204,229,255);
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f1f1f1;
            width: 100%;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }
        .dropdown-content p {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            width: 100%;
            display: block;
        }
        .show {display:block;}
    }
    </style>
{% endblock %}

{% block addon_js %}
    <script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>
    <script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"> </script>
    <script src="{% static 'home/js/select2.js' %}"> </script>
    <script src="{% static 'home/js/alignment.js' %}"> </script>
    <script src="{% static 'home/js/browser_functions.js' %}"> </script>


    <script type="text/javascript" charset="utf-8">
        $(document).ready(function () {
            // 'use strict';

            var oTable2 = $('#structures_scrollable').DataTable({
                "scrollY":        "65vh",
                "scrollX":        true,
                "scrollCollapse": true,
                "scroller": true,
                "paging":         false,
                // "bSortCellsTop": true,
                "aaSorting": [],
                "autoWidth": false,
                "order": [[28,'desc'],[1,'asc']],
                "columnDefs": [
                    { "targets": 'no-sort', "orderable": false }
                    ],
                "columns": [
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    {"width": "20%"},
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null
                ],
                "bInfo" : true,
            });

            var prev_ids = Array()
            var current_align_ids = Array()

            //Uncheck every row when using back button on browser
            $('.alt_selected').prop('checked',false)
            $('.alt').prop('checked',false)
            $('.select-all').prop('checked',false)
            //
            ClearSelection('targets');
            ClearSelection('reference');

            $("#loading_div").hide();

            yadcf.init(oTable2,
                [
                    {
                        column_number : 1,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_default_label: "UniProt",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '60px',
                        }
                    },
                    {
                        column_number : 2,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_default_label: "IUPHAR",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '60px',
                        }
                    },
                    {
                        column_number : 3,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_default_label: "Receptor family",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '120px',
                        }
                    }, 
                    {
                        column_number: 4,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        html_data_type: "text",
                        filter_default_label: "Class",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '80px',
                        }
                    },
                    {
                        column_number: 5,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Species",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '80px',
                        }
                    },
                    {
                        column_number : 6,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Method",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '60px',
                        }
                    },
                    {
                        column_number : 7,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        column_data_type: "html",
                        filter_default_label: "Select",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '50px',
                        }
                    }, 
                    {
                        column_number : 8,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Select",
                        column_data_type: "html",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '50px',
                        }
                    },
                    {
                        column_number : 9,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                    },
                    {
                        column_number : 10,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Select",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '50px',
                        }
                    },
                    {
                        column_number : 11,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "State",
                        filter_reset_button_text: false,
                        filter_match_mode : "exact",
                        select_type_options: {
                            width: '70px',
                        }
                    },
                    
                    {
                        column_number : 12,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                    },
                    {
                        column_number : 13,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Family",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '50px',
                        }
                    },
                    {
                        column_number : 14,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Subtype",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '55px',
                        }
                    },
                    {
                        column_number : 15,
                        filter_type: "text",
                        select_type: 'select2',
                        filter_default_label: "Note",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '80px',
                        }
                    },
                    {
                        column_number : 16,
                        filter_type: "range_number",
                        filter_default_label: ["From", "To"],
                        select_type_options: {
                            width: '50px',
                        }
                    },
                    {
                        column_number : 17,
                        filter_type: "text",
                        select_type: 'select2',
                        filter_default_label: "Fusion",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 18,
                        filter_type: "text",
                        select_type: 'select2',
                        filter_default_label: "Antibodies",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 19,
                        filter_type: "text",
                        select_type: 'select2',
                        html_data_type: "text",
                        filter_default_label: "Ligand name",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 20,
                        filter_type: "text",
                        select_type: 'select2',
                        html_data_type: "text",
                        filter_default_label: "Ligand type",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 21,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Ligand function",
                        filter_match_mode : "exact",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 22,
                        filter_type: "text",
                        select_type: 'select2',
                        filter_default_label: "Ligand name",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 23,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Ligand type",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '80px',
                        }
                    },
                    {
                        column_number : 24,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "D2x50-S3x39",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '80px',
                        }
                    },
                    {
                        column_number : 25,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Sodium in structure",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 26,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Senior author",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        }
                    },
                    {
                        column_number : 27,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Reference",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '140px',
                        }
                    },
                    {
                        column_number : 28,
                        filter_type: "range_date",
                        date_format: "yyyy-mm-dd",
                        select_type: 'select2',
                        filter_default_label: ["From", "To"],
                        // filter_reset_button_text: false,
                    },
                    {
                        column_number : 29,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Select",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '80px',
                        }
                    }
                ],
                {
                    cumulative_filtering: false
                }
            );

            yadcf.exResetAllFilters(oTable2);

            // $(function(){
            //     $(".wrapper").scroll(function(){
            //         $(".dataTables_scrollBody").eq(0).scrollLeft($(".wrapper").scrollLeft());
            //     });
            //     $(".dataTables_scrollBody").eq(0).scroll(function(){
            //         $(".wrapper").scrollLeft($(".dataTables_scrollBody").eq(0).scrollLeft());
            //     });
            // });
            
            $('#structures_scrollable'+' > tbody > tr').click(function(event) {
                if (event.target.type !== 'checkbox') {
                    $(':checkbox', this).trigger('click');
                    $(this).eq(0).toggleClass('alt_selected');
                    $(this).find('td').toggleClass('highlight');
                }
                $(this).eq(0).toggleClass('alt_selected');
                $(this).find('td').toggleClass('highlight');
            });

            $(".select-all").click(function() {
                $(':checkbox', this).trigger('click');
                if ($(this).prop('checked')===true) {
                    $('.alt').prop('checked', true);
                    $('.alt').parent().parent().addClass('alt_selected');
                    $('.alt').parent().parent().find('td').addClass('highlight');
                }
                if ($(this).prop('checked')===false) {
                    $('.alt').prop('checked', false);
                    $('.alt').parent().parent().removeClass('alt_selected');
                    $('.alt').parent().parent().find('td').removeClass('highlight');
                }
            });

            // $('.wrapper').find('div').width($(".yadcf-datatables-table--structures_scrollable").width());

            $('.hide_columns').click(function(evt) {
            var columns = $(this).attr('columns').split(",");
            columns.forEach(function(column) {
                var column = oTable2.column( column );
                try {
                    column.visible( false, false );
                }
                catch(err) {
                    column.visible( false, false );
                }
                });
                oTable2.draw();
            } );

            toggle_enabled = true;
            $('#toggle_fixed_btn').click(function() {
                if (toggle_enabled) {
                    toggle_enabled = false;
                    $("#overlay").hide();
                    $("#toggle_fixed_btn").attr('value',"Enable fixed columns");
                    $("#toggle_fixed_btn").addClass('clicked_button');
                } else {
                    toggle_enabled = true;
                    $('.dataTables_scrollBody').scroll();
                    $("#toggle_fixed_btn").attr('value',"Disable fixed columns");
                    $("#toggle_fixed_btn").removeClass('clicked_button');
                }
            });

            $("#toggle_columns_btn").click(function() {
                var columns = Array.from(new Array(24), (x,i) => i + 6);
                columns.forEach(function(column) {
                    var column = oTable2.column( column );
                    try {
                        column.visible( true, false );
                    }
                    catch(err) {
                        column.visible( true, false );
                    }
                });
                oTable2.draw();
            });

            $('#representative_btn').click(function () {
                $(this).toggleClass('toggled');
                if ($(this).hasClass('toggled')) {
                    $("#representative_btn").addClass('clicked_button');
                    $("#representative_btn").attr('value','All structures');
                }
                else {
                    $("#representative_btn").removeClass('clicked_button');
                    $("#representative_btn").attr('value','Representative structures');
                }
                oTable2.draw();
            });

            $.fn.dataTable.ext.search.push(
                function (settings, data, dataIndex) {
                    if ($('#representative_btn').hasClass('toggled')) {
                        if ($(oTable2.row(dataIndex).node()).hasClass("repr-st") && $(oTable2.row(dataIndex).node()).hasClass("repr-st")) {
                            return true;
                        }
                        return false;
                    }
                    else {
                        return true;
                    }
            });

            $('#align_btn').click(function () {
                var checked_data = oTable2.rows('.alt_selected').data();
                ClearSelection('targets');
                for (i = 0; i < checked_data.length; i++) {
                    var div = document.createElement("div");
                    div.innerHTML = checked_data[i][7];
                    if (typeof div.innerText !== "undefined") {
                        AddToSelection('targets', 'structure', div.innerText.replace(/\s+/g, ''));
                    } else {
                        AddToSelection('targets', 'structure', div.textContent.replace(/\s+/g, ''));
                    }
                }
                window.location.href = '/structure/selection_convert';
            });

            $('#superpose_btn').click(function() {
                superposition(oTable2, [7,1,2,3,4,5,11,28], 'structure_browser');
            });

            $('#download_btn').click(function () {
                ClearSelection('targets');
                var checked_data = oTable2.rows('.alt_selected').data();
                for (i = 0; i < checked_data.length; i++) {
                    var div = document.createElement("div");
                    div.innerHTML = checked_data[i][7];
                    if (typeof div.innerText !== "undefined") {
                        AddToSelection('targets', 'structure',  div.innerText.replace(/\s+/g, '') );
                    } else {
                        AddToSelection('targets', 'structure', div.textContent.replace(/\s+/g, ''));
                    }
                }
                window.location.href = '/structure/pdb_download_index';
            });
            
            $('#uniprot_copy').click(function () {
                copyToClipboard('uniprot');
            });
            $('#pdb_copy').click(function () {
                copyToClipboard('pdb');
            });
            
            $('#reset_filters_btn').click(function () {
                window.location.href = '/structure/'
            });

            $('.close_modal').click(function () {
                var modal = document.getElementById('myModal');
                modal.style.display = "none";
            });

            $('.dataTables_scrollBody').append('<div id=overlay><table id="overlay_table" class="row-border text-center compact dataTable no-footer text-nowrap"><tbody></tbody></table></div>');

            function create_overlay() {
                // This function fires upon filtering, to update what rows to show as an overlay
                $("#overlay_table tbody tr").remove(); 
                var $target = $("#overlay_table tbody");
                $("#structures_scrollable tbody tr").each(function() {
                    var $tds = $(this).children(),
                        $row = $("<tr></tr>");
                    // $row.append($tds.eq(0).clone()).append($tds.eq(1).clone()).appendTo($target);
                    $row.append($tds.eq(1).clone()).append($tds.eq(2).clone()).appendTo($target);
                    $row.height($(this).height());
                });
                $("#overlay_table .border-right").removeClass("border-right");
            }

            // Function that detects filtering events
            $('#structures_scrollable').on( 'draw.dt', function (e,oSettings) {
                create_overlay();
            });

            create_overlay();
            $("#overlay").hide();

            var left = 0;
            var old_left = 0;
            $('.dataTables_scrollBody').scroll(function(){
                // If user scrolls and it's >100px from left, then attach fixed columns overlay
                left = $('.dataTables_scrollBody').scrollLeft();
                if (left!=old_left) $("#overlay").hide();
                old_left = left;

                if (left>100 && toggle_enabled) {
                    $("#overlay").css({ left: left+'px' });
                    if ($("#overlay").is(":hidden")) $("#overlay").show();
                }
            });
            // console.log($('#yadcf-filter--structures_scrollable-from-12').width());
            // $('#yadcf-filter--structures_scrollable-from-12').width(10);
            // console.log($('#yadcf-filter--structures_scrollable-from-12').width());
            
        });

        var tableToExcel = (function () {
            var uri = 'data:application/vnd.ms-excel;base64,',
                template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>',
                base64 = function (s) {
                    return window.btoa(unescape(encodeURIComponent(s)))
                }, format = function (s, c) {
                    return s.replace(/{(\w+)}/g, function (m, p) {
                        return c[p];
                    })
                }
            return function (table, name, filename) {
                    var table= $("#"+table).clone();
                    $("#excel_table").html(table);
                    // Clean up table to remove yadcf stuff
                    $("#excel_table thead tr").css('height','');
                    $("#excel_table thead th").css('height','');
                    $("#excel_table thead div").css('height','');
                    $("#excel_table thead .yadcf-filter-wrapper").remove();
                    $("#excel_table thead button").remove();
                    var tr = $("#excel_table thead tr:eq(1)");
                    // reattach th titles
                    tr.find('th').each (function( column, th) {
                      if ($(th).attr('title')) $(th).html($(th).attr('title'));
                    });     

                var ctx = {
                    worksheet: name || 'Worksheet',
                    table: $("#excel_table").html()
                }
                $("#excel_table").html("");
                document.getElementById("dlink").href = uri + base64(format(template, ctx));
                document.getElementById("dlink").download = filename;
                document.getElementById("dlink").click();
            }
        })()

        function copyDropdown() {
            document.getElementById("Dropdown").classList.toggle("show");
        }

        window.onclick = function(event) {
            if (!event.target.matches('.dropbtn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                var i;
                for (i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        function copyToClipboard(data) {
            var link = $('.alt_selected > .'+data+' > a');
            var out = [];
            link.each(function() {
                var ele = $(this).attr('href').split('/');
                out.push(ele[ele.length-1])
            });
            console.log(out);
            if (out.length===0) {
                window.alert('No entries selected for copying')
                return 0
            }
            var textArea = document.createElement("textarea");
            textArea.value = out;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            var successful = document.execCommand('copy');
            document.body.removeChild(textArea);
        }

    </script> 
{% endblock %}

{% block content %}
<div id="browser">
    <div style="display:block;">
        <div style="display:inline; float:left;">
            <h2 style="width:auto; display:inline;">Structures</h2>
        </div>
        <div style="float:left; padding:4px 0px 0px 6px;">
            <div style="font-size: 10px; ">
                <a href="https://academic.oup.com/nar/article/44/D1/D356/2502664"> read article</a><br>
                <a href="https://academic.oup.com/nar/article/44/D1/D356/2502664"> latest GPCRdb article</a>
            </div>
        </div>
    </div>
    <br><br>

    <div style='width:100%; display:inline;'>
        <div class="btn-group">
            <a id="dlink"  style="display:none;"></a>
            <div id="excel_table"  style2="display:none;"></div>
            <!-- <input class="btn btn-default btn-s" type="button" id="toggle_fixed_btn" value="Disable fixed columns" href="javascript:void(0)" data-toggle="buttons"></input> -->
            <input class="btn btn-default btn-s" type="button" id="toggle_columns_btn" value="Show hidden columns" href="javascript:void(0)">
            <input class="btn btn-default btn-s" type="button" id="representative_btn" value="Representative structures" href="javascript:void(0)" data-toggle="buttons"></input>
        </div>
        <div class="btn-group" style='padding-left:10px;'>
            <label class="btn btn-default btn-s" id="align_btn" href="javascript:void(0)">
                Align seqs
            </label>
            <label class="btn btn-default btn-s" id="download_btn" href="javascript:void(0)">
                Download PDBs
            </label>
            <label class="btn btn-default btn-s" id="superpose_btn" href="javascript:void(0)">
                Superposition
            </label>
            <input class="btn btn-default btn-s" type="button" onclick="tableToExcel('structures_scrollable', 'Structure data', 'GPCRdb_structures.xls')" value="Export Excel"></input>
            <!-- <div class="dropdown">
                <button onclick="copyDropdown()" class="dropbtn btn btn-default btn-s">Copy Selected</button>
                <div id="Dropdown" class="dropdown-content">
                    <p class="btn btn_default btn-s" type="button" id="uniprot_copy">UniProts</p>
                    <p class="btn btn_default btn-s" type="button" id="pdb_copy">PDBs</p>
                </div>
            </div> -->
            <!-- <label class="btn btn-default btn-s" id="reset_filters_btn" href="javascript:void(0)">
                Reset All
            </label> -->

            <!-- <div style="float:right;">
                <input id="filter_input" placeholder="PDBs/UniProts..."></input>
                <label class="btn btn-default btn-s" id="filter_button" href="javascript:void(0)">
                    <i class="glyphicon glyphicon-search"></i>
                </label>
            </div> -->
        </div>
    </div>
    <br />

    <div style="padding-top: 0px; font-size: 15px; white-space: nowrap;" id="loading_div">
    <br>Loading...
    </div>

    <!-- scrollable column -->
    <div style='padding-top: 0px; font-size: 10px; white-space: nowrap; width:100%; overflow-y:hidden; display:inline-block; width:100%;'>
        <!-- <div class='wrapper' style='height:20px;width:100%;'>
            <div style='height:20px;width:3000px;'></div>
        </div> -->
        <div id='structures_scrollable_div'>
            <table class="display compact text-nowrap" id='structures_scrollable'>
                <thead>
                    <tr class='over_header over_header_row'>
                        <th colspan=6 class="over_header" style='height:35px; text-align:left;'>RECEPTOR</th>
                        <th colspan=7 class="over_header flexible_over_header" id='structure_over_header'>
                            <!-- <label class="btn btn-default btn-xs" style="border-radius:50%;"> - </label> -->
                            STRUCTURE
                            <!-- <div class="hide_columns" columns="6,7,8,9,10,11,12" style="float:right;display:inline;"> -->
                                <button type="button" class="close hide_columns" columns="6,7,8,9,10,11,12" style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <!-- </div> -->
                        </th>
                        <th colspan=4 class="over_header flexible_over_header" id='sign_prot_over_header'>
                            SIGNAL PROTEIN
                            <!-- <div class="hide_columns" columns="13,14" style="float:right;display:inline;"> -->
                                <button type="button" class="close hide_columns" columns="13,14,15,16" style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <!-- </div> -->
                        </th>
                        <th colspan=2 class="over_header flexible_over_header" id='aux_prot_over_header'>
                            AUXILIARY PROTEIN
                            <!-- <div class="hide_columns" columns="15,16" style="float:right;display:inline;"> -->
                                <button type="button" class="close hide_columns" columns="17,18" style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <!-- </div> -->
                        </th>
                        <th colspan=3 class="over_header flexible_over_header" id='structure_ligand_over_header'>
                            STRUCTURE LIGAND
                            <!-- <div class="hide_columns" columns="17,18,19" style="float:right;display:inline;"> -->
                                <button type="button" class="close hide_columns" columns="19,20,21" style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <!-- </div> -->
                        </th>
                        <th colspan=2 class="over_header flexible_over_header" id='endo_ligand_over_header'>
                            ENDOGENOUS LIGAND
                            <!-- <div class="hide_columns" columns="19,20" style="float:right;display:inline;"> -->
                                <button type="button" class="close hide_columns" columns="22,23" style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <!-- </div> -->
                        </th>
                        <th colspan=2 class="over_header flexible_over_header" id='sodium_over_header'>
                            SODIUM ION SITE
                            <!-- <div class="hide_columns" columns="22,23" style="float:right;display:inline;"> -->
                                <button type="button" class="close hide_columns" columns="24,25" style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <!-- </div> -->
                        </th>
                        <th colspan=3 class="over_header flexible_over_header" id='reference_over_header'>
                            REFERENCE
                            <!-- <div class="hide_columns" columns="24,25,26" style="float:right;display:inline;"> -->
                                <button type="button" class="close hide_columns" columns="26,27,28" style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <!-- </div> -->
                        </th>
                        <th colspan=1 class="over_header flexible_over_header" id='annotated_over_header'>
                            ANNOTATED
                            <!-- <div class="hide_columns" columns="27" style="float:right;display:inline;"> -->
                                <button type="button" class="close hide_columns" columns="29," style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <!-- </div> -->
                        </th>
                    </tr>
                    <tr>
                        <th class='no-sort checkbox_tr'><input class="select-all" type="checkbox" onclick="select_all(this)"></th>
                        <th style='height: 70px;'></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th>PDB</th>
                        <th><a href="https://academic.oup.com/nar/article/44/D1/D356/2502664" target="_blank">Refined<br>structure</a></th>
                        <th>Resolution</th>
                        <th>Preferred<br>chain</th>
                        <th></th>
                        <th class='rightborder'><a href="http://docs.gpcrdb.org/structures.html" target="_blank">7TM Open IC (Å)</a></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th class='rightborder'>% of Seq</th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th class='rightborder'></th>
                        <th></th>
                        <th></th>
                        <th class='rightborder'>PDB Date</th>
                        <th class='rightborder'></th>
                    </tr>

                </thead>
                <tbody>
                {% for structure in structures.all %}
                    {% if structure.representative %}
                        <tr class="repr-st" model_id='{{structure.pk}}'>
                    {% else %}
                        <tr model_id='{{structure.pk}}'>
                    {% endif %}
                        <td class="text-center"><input class="alt" type="checkbox" id="{{ structure.pk }}"></td>
                        <td><span><a href="http://www.uniprot.org/uniprot/{{ structure.protein_conformation.protein.parent.accession }}">{{ structure.protein_conformation.protein.parent.entry_short|safe }}</a></span></td>
                        <td class='uniprot'><a href="/protein/{{ structure.protein_conformation.protein.parent.entry_name }}">{{ structure.protein_conformation.protein.parent.short|safe }}</a></td>
                        <td><span>{{ structure.protein_conformation.protein.family.parent.short|safe }}</span></td>
                        <td><span>{{ structure.protein_conformation.protein.family.parent.parent.parent.name|cut_classname }}</span></td>
                        <td>{{ structure.protein_conformation.protein.species.common_name }}</td>
                        <td>
                            {{ structure.structure_type.type_short|escape }}
                        </td>
                        <td class="pdb text-left">
                            <a href="{{ structure.pdb_code.index}}">{{ structure.pdb_code.index}}</a>
                        </td>
                        <td>
                            {% if structure.is_refined %}
                            <a href="homology_models/{{ structure.pdb_code.index }}_refined">{{structure.pdb_code.index}}_refined</a>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="text-center">{{ structure.resolution|floatformat:"1" }}</td>
                        <td class="text-center">{{ structure.preferred_chain }}</td>
                        <td>{{ structure.state.name }}</td>
                        <td class="text-center">{{ structure.distance|floatformat:"1" }}</td>
                        <td>
                            {% for ep in structure.extra_proteins.all %}
                                {% if ep.category == "Arrestin" %}
                                    {{ ep.wt_protein.family.parent.parent.name }}
                                {% else %}
                                    {{ ep.wt_protein.family.parent.name }}
                                {% endif %}
                                {% empty %}
                                    -
                            {% endfor %}
                        </td>
                        <td>
                            {% for ep in structure.extra_proteins.all %}
                                {{ ep.display_name}}
                                {% empty %}
                                    -
                            {% endfor %}
                        </td>
                        <td>
                            {% for ep in structure.extra_proteins.all %}
                                {% if ep.note is None %}
                                    -
                                {% else %}
                                    {% if ep.note|length > 20 %}
                                        <span title="{{ ep.note }}">{{ ep.note|cut_at_20 }}...</span>
                                    {% else %}
                                    {{ ep.note }}
                                    {% endif %}
                                {% endif %}
                                {% empty %}
                                    -
                            {% endfor %}
                        </td>
                        <td>
                            {% for ep in structure.extra_proteins.all %}
                                {{ ep.wt_coverage}}
                                {% empty %}
                                    -
                            {% endfor %}
                        </td>
                        <td>
                            {{ structure.stabilizing_agents.all|only_fusions|linebreaksbr }}
                        </td>
                        <td>
                            {{ structure.stabilizing_agents.all|only_antibodies|linebreaksbr }}
                        </td>
                        <td>
                            {% for ligand in structure.ligands.all %}
                                {% if ligand.ligand.name|safe|length > 20 %}
                                    <span title="{{ ligand.ligand.name|safe }}">{{ ligand.ligand.name|safe|cut_at_20 }}...</span>
                                {% else %}
                                    {{ ligand.ligand.name|safe }}
                                {% endif %}
                            {% for link in ligand.ligand.properities.web_links.all %}
                                <a href="{{ link}}" target="_blank">{{link.web_resource.slug}}</a>
                            {% endfor %}
                                <br />
                            {% empty %}
                                N/A
                            {% endfor %}
                        </td>
                        <td>
                            {{ structure.ligands.all|ligandtype|linebreaksbr }}
                        </td>
                        <td>
                            {{ structure.ligands.all|ligandrole|linebreaksbr }}
                        </td>
                        <td>
                            {% if structure.protein_conformation.protein.parent.endogenous_ligands.all|lineformat|length > 20 %}
                                <span title="{{ structure.protein_conformation.protein.parent.endogenous_ligands.all|lineformat }}">{{ structure.protein_conformation.protein.parent.endogenous_ligands.all|lineformat|cut_at_20 }}...</span>
                            {% else %}
                                {{ structure.protein_conformation.protein.parent.endogenous_ligands.all|lineformat }}
                            {% endif %}
                        </td>
                        <td>{{ structure.protein_conformation.protein.parent.endogenous_ligands.all.0.properities.ligand_type }}</td>
                        <td>
                            {% if structure.protein_conformation.is_sodium %}
                            Yes
                            {% else %}
                            No
                            {% endif %}
                        </td>
                        <td>
                            {% if structure.sodium %}
                            Yes
                            {% else %}
                            No
                            {% endif %}
                        </td>
                        <td>
                            {{ structure.publication.authors|senior_author}}
                        </td>
                        <td>
                            <a href="{{ structure.publication.web_link }}">
                            {{ structure.publication.web_link.index }}
                            </a>
                        </td>
                        <td>{{ structure.publication_date|date:"Y-m-d" }}</td>
                        <td>
                            {% if structure.annotated %}
                            Yes
                            {% else %}
                            No
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <!-- </div> -->
</div>
<div id="myModal" class="modal">
  <!-- Modal content -->
    <div class="modal-content">
        <button style="float:right;display:inline;" aria-hidden="true" aria-label="Close" class="close close_modal" href="javascript:void(0)">&times;</button>
        <h3>Pick template from selection</h3>
        <p>Superpositions structures selected in the browser to the template checked in this table</p>
        <br>
        <table id="modal_table" class="display compact" width="100%">
            <thead>
                <tr>
                    <th></th>
                    <th>PDB</th>
                    <th>UniProt</th>
                    <th>IUPHAR</th>
                    <th>Rec. family</th>
                    <th>Class</th>
                    <th>Species</th>
                    <th>State</th>
                    <th>PDB Date</th>
                </tr>
            </thead>
            <tbody>
                <!-- Javascript populates the table from selected rows -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}


